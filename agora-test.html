
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Feature-Policy" content="camera *; microphone *;">
    <meta http-equiv="Permissions-Policy" content="camera=*, microphone=*">
    <title>Agora Video Call</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <script>
        // 自定义console.log函数，将日志发送到React Native
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        const originalConsoleInfo = console.info;
        
        function sendLogToNative(level, args) {
            if (window.ReactNativeWebView) {
                try {
                    // 处理console.log的CSS样式化参数
                    const argsArray = Array.from(args);
                    let processedArgs = [];
                    
                    for (let i = 0; i < argsArray.length; i++) {
                        const arg = argsArray[i];
                        
                        // 如果是字符串且包含%c，说明下一个参数是CSS样式
                        if (typeof arg === 'string' && arg.includes('%c')) {
                            // 移除%c标记，保留文本内容
                            const cleanedArg = arg.replace(/%c/g, '');
                            processedArgs.push(cleanedArg);
                            
                            // 跳过下一个CSS样式参数
                            const nextArg = argsArray[i + 1];
                            if (typeof nextArg === 'string' && 
                                (nextArg.includes('color:') || nextArg.includes('font-'))) {
                                i++; // 跳过CSS样式参数
                            }
                        } else {
                            // 普通参数，直接处理
                            if (typeof arg === 'object' && arg !== null) {
                                try {
                                    processedArgs.push(JSON.stringify(arg));
                                } catch (e) {
                                    processedArgs.push(String(arg));
                                }
                            } else {
                                processedArgs.push(String(arg));
                            }
                        }
                    }
                    
                    const message = processedArgs.join(' ');
                    
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'webview_log',
                        level: level,
                        message: message,
                        timestamp: new Date().toISOString()
                    }));
                } catch (e) {
                    originalConsoleError('Failed to send log to native:', e);
                }
            }
            // 保持原有的console功能
            if (level === 'error') {
                originalConsoleError.apply(console, args);
            } else if (level === 'warn') {
                originalConsoleWarn.apply(console, args);
            } else if (level === 'info') {
                originalConsoleInfo.apply(console, args);
            } else {
                originalConsoleLog.apply(console, args);
            }
        }
        
        // 重写console方法，支持多参数
        console.log = function() {
            sendLogToNative('info', arguments);
        };
        
        console.error = function() {
            sendLogToNative('error', arguments);
        };
        
        console.warn = function() {
            sendLogToNative('warn', arguments);
        };
        
        console.info = function() {
            sendLogToNative('info', arguments);
        };
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: Arial, sans-serif;
        }
        
        #container {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        

        
        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #333;
        }
        
        
        
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1;
        }
        
        #audio-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1;
        }
        
        #error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 1001;
            display: none;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="loading">连接中...</div>
        <div id="error-message"></div>

        <div id="remote-video"></div>
        
        <div id="status" style="display:'block'">未连接</div>
        <div id="audio-status" style="display: 'block'">音频未启用</div>
        
        
    </div>

    <script>
        let rtc = {
            client: null,
            localVideoTrack: null,
            localAudioTrack: null,
        };
        
        // 默认配置，会被 React Native 传递的配置覆盖
        let options = {
            appId: "",
            channel: "",
            token: "",
            uid: null,
        };
        
        // 配置是否已接收标志
        let configReceived = false;
        
        // 添加配置调试日志
        console.log('🎯 初始化 Agora 配置（等待 React Native 传递）:', options);
        
        let isVideoMuted = false;
        let isAudioMuted = false;
        let isTalking = false;
        let hasRemoteAudio = false;
        let connectionState = 'disconnected';
        
        // 音频编码配置选项 - 针对对讲优化
        const audioConfigs = {
            // 语音通话优化 (16kHz, Mono, ~32kbps) - 适合对讲
            "speech_low_quality": {
                sampleRate: 16000,
                stereo: false,
                bitrate: 32
            },
            // 标准语音 (32kHz, Mono, ~64kbps) 
            "speech_standard": {
                sampleRate: 32000,
                stereo: false,
                bitrate: 64
            }
        };
        
        // 状态更新函数
        function updateStatus(status) {
            // 只有调试用户才显示状态
            // const isDebugUser = ${DebugTool.isDebugUsers()};
            // if (isDebugUser) {
            //     document.getElementById('status').textContent = status;
            // } else {
            //     document.getElementById('status').textContent = '';
            // }
            connectionState = status;
            
            // 通知 React Native
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'statusChanged',
                    status: status
                }));
            }
        }
        
        function updateAudioStatus(status) {
            // 只有调试用户才显示音频状态
            // const isDebugUser = ${DebugTool.isDebugUsers()};
            // if (isDebugUser) {
            //     document.getElementById('audio-status').textContent = status;
            // } else {
            //     document.getElementById('audio-status').textContent = '';
            // }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // 如果是成功消息，改变样式
            if (message.includes('成功')) {
                errorDiv.style.background = 'rgba(76, 175, 80, 0.8)';
            } else {
                errorDiv.style.background = 'rgba(255, 0, 0, 0.8)';
            }
            
            // 通知 React Native
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'error',
                    message: message
                }));
            }
        }
        
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // 初始化 Agora 客户端
        async function initializeAgora() {
            console.log('🎯 开始初始化 Agora 客户端');
            try {
                // 明确设置为主播角色，确保有发布权限
                rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                console.log('🎯 Agora 客户端创建成功（主播模式）');
                
                // 监听事件
                rtc.client.on("user-published", handleUserPublished);
                rtc.client.on("user-unpublished", handleUserUnpublished);
                rtc.client.on("user-joined", handleUserJoined);
                rtc.client.on("user-left", handleUserLeft);
                rtc.client.on("connection-state-change", handleConnectionStateChange);
                console.log('🎯 Agora 事件监听器已设置');
                
                updateStatus('已初始化');
                hideLoading();
                console.log('🎯 Agora 初始化完成');
                
                // 通知 React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'initialized'
                    }));
                    console.log('🎯 已通知 React Native 初始化完成');
                } else {
                    console.error('🎯 window.ReactNativeWebView 不存在');
                }
                
            } catch (error) {
                console.error('🎯 初始化失败:', error);
                showError('初始化失败: ' + error.message);
            }
        }
        
        // 创建并发布初始轨道（加入频道后立即调用）
        async function createAndPublishInitialTracks() {
            try {
                console.log('🎯 开始创建初始轨道...');
                const tracks = [];
                
                // 创建音频轨道（静音状态）
                const audioTrack = await createAudioTrack();
                if (audioTrack) {
                    // 立即静音，用户点击对讲时再取消静音
                    await audioTrack.setMuted(true);
                    isAudioMuted = true;
                    tracks.push(audioTrack);
                    console.log('✅ 音频轨道已创建（静音状态）');
                }
                
                // 不创建本地视频轨道，只使用音频轨道
                
                // 发布所有轨道
                if (tracks.length > 0) {
                    await rtc.client.publish(tracks);
                    console.log(`✅ 已发布 ${tracks.length} 个轨道，获得主播权限`);
                    
                    updateAudioStatus('轨道已发布（音频静音）');
                    
                    // 通知 React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'tracksPublished',
                            audioTrack: !!audioTrack,
                        }));
                    }
                } else {
                    console.warn('⚠️ 没有轨道可发布');
                }
                
            } catch (error) {
                console.error('❌ 创建初始轨道失败:', error);
                showError('创建媒体轨道失败: ' + error.message);
            }
        }
        
        // 移除本地视频轨道创建功能
        
        // 创建音频轨道（参考 agora-test.html 的成功做法）
        async function createAudioTrack() {
            try {
                console.log('🎤 开始创建音频轨道...');
                
                // 使用与 agora-test.html 完全相同的配置
                const config = audioConfigs["speech_low_quality"];
                
                // 创建 Agora 音频轨道
                rtc.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack({
                    encoderConfig: {
                        sampleRate: config.sampleRate,
                        stereo: config.stereo,
                        bitrate: config.bitrate
                    },
                    // 启用音频处理
                    AEC: true,  // 回声消除
                    AGC: true,  // 自动增益控制
                    ANS: true   // 噪声抑制
                });
                
                console.log('✅ 音频轨道创建成功');
                console.log('🔧 音频配置:', {
                    sampleRate: config.sampleRate + 'Hz',
                    channels: config.stereo ? 'Stereo' : 'Mono',
                    bitrate: config.bitrate + 'kbps',
                    codec: 'Opus'
                });
                updateAudioStatus('音频轨道已创建');
                
                // 通知 React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'audioTrackCreated'
                    }));
                }
                
                return rtc.localAudioTrack;
            } catch (error) {
                console.error('❌ 音频轨道创建失败:', error);
                
                let errorMsg = '音频轨道创建失败';
                if (error.code === 'NOT_SUPPORTED') {
                    errorMsg = '当前环境不支持音频功能';
                } else if (error.code === 'PERMISSION_DENIED' || error.message.includes('权限')) {
                    errorMsg = '麦克风权限被拒绝';
                } else if (error.code === 'NOT_READABLE' || error.message.includes('NotReadableError')) {
                    errorMsg = '无法访问麦克风设备，可能被其他应用占用';
                } else {
                    errorMsg = `音频轨道创建失败: ${error.message}`;
                }
                
                showError(errorMsg);
                updateAudioStatus('音频轨道创建失败');
                return null;
            }
        }
        
        // 加入频道
        async function joinChannel() {
            try {
                hideError();

                // 检查配置是否已接收
                if (!configReceived) {
                    console.log('🎯 配置尚未接收，等待配置...');
                    showError('等待配置信息...');
                    updateStatus('等待配置');
                    
                    // 请求配置
                    sendMessageToReactNative({
                        type: 'requestConfig'
                    });
                    return;
                }

                // 先尝试获取用户媒体权限（这是关键步骤）
                try {
                    const testStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('✅ 音频权限获取成功');
                    // 立即停止测试流
                    testStream.getTracks().forEach(track => track.stop());
                } catch (permError) {
                    console.error('❌ 音频权限获取失败:', permError);
                    throw new Error('麦克风权限被拒绝或不可用');
                }

                updateStatus('连接中...');

                // 检查配置是否完整
                if (!options.appId || !options.channel || !options.token) {
                    showError('声网配置不完整，请稍后重试');
                    updateStatus('配置错误');
                    return;
                }

                
                // 加入频道
                options.uid = await rtc.client.join(
                    options.appId,
                    options.channel,
                    options.token,
                    options.uid
                );
                
                updateStatus('已连接');
                console.log('✅ 成功加入频道，开始创建并发布轨道...');
                
                // 立即创建并发布轨道，确保主播权限
                await createAndPublishInitialTracks();
                
                // 通知 React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'joinedChannel',
                        uid: options.uid,
                        channel: options.channel
                    }));
                }
                
            } catch (error) {
                console.error('加入频道失败:', error);
                showError('加入频道失败: ' + error.message);
                updateStatus('连接失败');
            }
        }
        
        // 离开频道
        async function leaveChannel() {
            try {
                // 停止对讲
                if (isTalking) {
                    await stopTalk();
                }
                
                // 本地视频轨道已移除
                
                if (rtc.localAudioTrack) {
                    rtc.localAudioTrack.stop();
                    rtc.localAudioTrack.close();
                    rtc.localAudioTrack = null;
                }
                
                // 离开频道
                await rtc.client.leave();
                
                updateStatus('已断开');
                updateAudioStatus('音频未启用');
                
                
                // 重置状态
                isTalking = false;
                hasRemoteAudio = false;
                isAudioMuted = false;
                isVideoMuted = false;
                
                
                // 清空视频容器
                document.getElementById('remote-video').innerHTML = '';
                
                
                // 通知 React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'leftChannel'
                    }));
                }
                
            } catch (error) {
                console.error('离开频道失败:', error);
                showError('离开频道失败: ' + error.message);
            }
        }
        
        // 开始对讲
        async function startTalk() {
            try {
                console.log('🎤 开始对讲...');
                
                // 检查音频轨道是否存在
                if (!rtc.localAudioTrack) {
                    console.log('🎤 音频轨道不存在，重新创建...');
                    // 如果不存在，创建并发布音频轨道
                    const audioTrack = await createAudioTrack();
                    if (!audioTrack) {
                        showError('无法创建音频轨道，请检查麦克风权限');
                        return;
                    }
                    await rtc.client.publish([audioTrack]);
                }
                
                // 取消音频静音
                if (rtc.localAudioTrack) {
                    await rtc.localAudioTrack.setMuted(false);
                    isAudioMuted = false;
                    isTalking = true;
                    updateAudioStatus('正在对讲...');
                    
                    console.log('✅ 对讲开始成功（取消静音）');
                    
                    // 通知 React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'talkStarted'
                        }));
                    }
                } else {
                    showError('音频轨道不可用');
                }
                
            } catch (error) {
                console.error('❌ 开始对讲失败:', error);
                showError('开始对讲失败: ' + error.message);
                updateAudioStatus('对讲启动失败');
            }
        }
        
        // 停止对讲
        async function stopTalk() {
            try {
                console.log('🔇 停止对讲...');
                
                if (rtc.localAudioTrack) {
                    // 设为静音而不是取消发布，保持主播权限
                    await rtc.localAudioTrack.setMuted(true);
                    isAudioMuted = true;
                    isTalking = false;
                    
                    updateAudioStatus(hasRemoteAudio ? '接收远端音频（本地静音）' : '音频轨道已发布（静音）');
                    
                    console.log('✅ 对讲停止成功（设为静音）');
                    
                    // 通知 React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'talkStopped'
                        }));
                    }
                } else {
                    console.log('⚠️ 音频轨道不存在，无需停止对讲');
                }
                
            } catch (error) {
                console.error('❌ 停止对讲失败:', error);
                showError('停止对讲失败: ' + error.message);
            }
        }
        
        // 切换对讲状态
        async function toggleTalk() {
            if (isTalking) {
                await stopTalk();
            } else {
                await startTalk();
            }
        }
        
        // 视频功能已移除
        
        // 切换音频静音
        async function toggleAudioMute() {
            try {
                if (!rtc.localAudioTrack) {
                    showError('请先开始对讲');
                    return;
                }
                
                isAudioMuted = !isAudioMuted;
                await rtc.localAudioTrack.setMuted(isAudioMuted);
                
                
                updateAudioStatus(isAudioMuted ? '音频已静音' : '正在对讲...');
                
            } catch (error) {
                console.error('切换音频失败:', error);
                showError('切换音频失败: ' + error.message);
            }
        }
        
        // 处理远端用户发布流
        async function handleUserPublished(user, mediaType) {
            try {
                console.log('用户发布流:', user.uid, mediaType);
                await rtc.client.subscribe(user, mediaType);
                
                if (mediaType === 'video') {
                    console.log('开始播放远端视频:', user.uid);
                    user.videoTrack.play('remote-video');
                    
                    // 显示远端视频
                    document.getElementById('remote-video').style.display = 'block';
                    
                    // 通知 React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'remoteVideoStarted',
                            uid: user.uid
                        }));
                    }
                }
                
                if (mediaType === 'audio') {
                    console.log('开始播放远端音频:', user.uid);
                    user.audioTrack.play();
                    user.audioTrack.setVolume(100);
                    
                    hasRemoteAudio = true;
                    updateAudioStatus('接收远端音频');
                    
                    // 通知 React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'remoteAudioStarted',
                            uid: user.uid
                        }));
                    }
                }
                
            } catch (error) {
                console.error('订阅远端流失败:', error);
                showError('订阅远端流失败: ' + error.message);
            }
        }
        
        // 处理远端用户取消发布流
        function handleUserUnpublished(user, mediaType) {
            console.log('handleUserUnpublished', user, mediaType);
            if (mediaType === 'video') {
                console.log('远端用户停止发布视频:', user.uid);
                document.getElementById('remote-video').innerHTML = '';
                
                // 远端用户取消发布视频流时，自动离开频道
                console.log('远端用户取消发布视频流，准备离开频道...');
                setTimeout(() => {
                    leaveChannel();
                }, 500); // 延迟500ms离开，确保状态更新完成
                
                // 通知 React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'remoteVideoStopped',
                        uid: user.uid
                    }));
                }
            }
            
            if (mediaType === 'audio') {
                console.log('远端用户停止发布音频:', user.uid);
                hasRemoteAudio = false;
                updateAudioStatus(isTalking ? '正在对讲...' : '音频未启用');
                
                // 通知 React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'remoteAudioStopped',
                        uid: user.uid
                    }));
                }
            }
        }
        
        // 处理用户加入
        function handleUserJoined(user) {
            console.log('用户加入:', user.uid);
            
            // 通知 React Native
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'userJoined',
                    uid: user.uid
                }));
            }
        }
        
        // 处理用户离开
        function handleUserLeft(user) {
            console.log('用户离开:', user.uid);
            
            // 通知 React Native
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'userLeft',
                    uid: user.uid
                }));
            }
        }
        
        // 处理连接状态变化
        function handleConnectionStateChange(curState, revState, reason) {
            console.log('连接状态变化:', curState, revState, reason);
            
            let statusText = '未知状态';
            switch (curState) {
                case 'DISCONNECTED':
                    statusText = '未连接';
                    break;
                case 'CONNECTING':
                    statusText = '连接中...';
                    break;
                case 'CONNECTED':
                    statusText = '已连接';
                    break;
                case 'RECONNECTING':
                    statusText = '重连中...';
                    break;
                case 'DISCONNECTING':
                    statusText = '断开中...';
                    break;
            }
            
            updateStatus(statusText);
        }
        
        // 发送消息到 React Native
        function sendMessageToReactNative(message) {
            if (window.ReactNativeWebView) {
                try {
                    window.ReactNativeWebView.postMessage(JSON.stringify(message));
                    console.log('🎯 已发送消息到 React Native:', message);
                } catch (error) {
                    console.error('🎯 发送消息到 React Native 失败:', error);
                }
            } else {
                console.warn('🎯 window.ReactNativeWebView 不存在，无法发送消息');
            }
        }
        
        // 处理设置配置消息
        function handleSetConfig(config) {
            try {
                console.log('🎯 接收到配置:', config);
                
                // 验证配置完整性
                if (!config || !config.appId || !config.token || !config.channelName) {
                    console.error('🎯 配置不完整:', config);
                    sendMessageToReactNative({
                        type: 'configError',
                        message: '配置不完整'
                    });
                    return;
                }
                
                // 更新配置
                options.appId = config.appId;
                options.channel = config.channelName;
                options.token = config.token;
                configReceived = true;
                
                console.log('🎯 配置已更新:', {
                    appId: options.appId ? options.appId.substring(0, 8) + '...' : '空',
                    channel: options.channel || '空',
                    token: options.token ? options.token.substring(0, 20) + '...' : '空'
                });
                
                // 发送配置接收确认
                sendMessageToReactNative({
                    type: 'configReceived',
                    config: {
                        appId: !!options.appId,
                        channel: !!options.channel,
                        token: !!options.token
                    }
                });
                
            } catch (error) {
                console.error('🎯 处理配置失败:', error);
                sendMessageToReactNative({
                    type: 'configError',
                    message: '处理配置失败: ' + error.message
                });
            }
        }
        
        
        // 初始化
        window.addEventListener('load', function() {
            console.log('🎯 页面加载完成，开始初始化');
            if (window.sendEarlyLog) {
                window.sendEarlyLog('页面加载完成，准备初始化Agora');
            }
            initializeAgora();
        });
        

        // 处理来自 React Native 的消息
        const handleMessage = function(event) {
            console.log('🎯 WebView received message: ' + event.data);
            
            try {
                const data = JSON.parse(event.data);
                console.log('🎯 Parsed message data: ' + JSON.stringify(data));
                console.log('🎯 Message type: ' + data.type);
                
                switch (data.type) {
                    case 'setConfig':
                        console.log('🎯 Processing setConfig message');
                        handleSetConfig(data.config);
                        break;
                    case 'joinChannel':
                        console.log('🎯 Processing joinChannel message');
                        joinChannel();
                        break;
                    case 'leaveChannel':
                        console.log('🎯 Processing leaveChannel message');
                        leaveChannel();
                        break;
                    // 视频功能已移除
                    case 'toggleAudio':
                        console.log('🎯 Processing toggleAudio message');
                        toggleAudioMute();
                        break;
                    case 'startTalk':
                        console.log('🎯 Processing startTalk message');
                        startTalk();
                        break;
                    case 'stopTalk':
                        console.log('🎯 Processing stopTalk message');
                        stopTalk();
                        break;
                    case 'toggleTalk':
                        console.log('🎯 Processing toggleTalk message');
                        toggleTalk();
                        break;
                    default:
                        console.log('🎯 Unknown message type: ' + data.type);
                        break;
                }
            } catch (error) {
                console.log('🎯 Error parsing message: ' + error.message);
            }
        };

        // 等待DOM加载完成后设置消息监听器
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 DOM 加载完成，平台:', window.ReactNativeOS);
            
            // 根据平台选择不同的事件监听器
            if (window.ReactNativeOS === "android") {
                console.log('🎯 Android平台: 在document上设置消息监听器');
                document.addEventListener("message", handleMessage);
            } else {
                console.log('🎯 iOS平台: 在window上设置消息监听器');
                window.addEventListener("message", handleMessage);
            }
            
            console.log('🎯 消息监听器设置成功');
        });
        
        // 如果DOM已经加载完成，直接设置监听器
        if (document.readyState === 'loading') {
            console.log('🎯 文档正在加载中，等待DOMContentLoaded事件');
        } else {
            console.log('🎯 文档已加载完成，直接设置消息监听器');
            console.log('🎯 当前平台:', window.ReactNativeOS);
            
            if (window.ReactNativeOS === "android") {
                console.log('🎯 Android平台: 在document上设置消息监听器');
                document.addEventListener("message", handleMessage);
            } else {
                console.log('🎯 iOS平台: 在window上设置消息监听器');
                window.addEventListener("message", handleMessage);
            }
            
            console.log('🎯 消息监听器设置完成');
        }
    </script>
</body>
</html>
