
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Feature-Policy" content="camera *; microphone *;">
    <meta http-equiv="Permissions-Policy" content="camera=*, microphone=*">
    <title>Agora Video Call</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
    <script>
        // è‡ªå®šä¹‰console.logå‡½æ•°ï¼Œå°†æ—¥å¿—å‘é€åˆ°React Native
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        const originalConsoleInfo = console.info;
        
        function sendLogToNative(level, args) {
            if (window.ReactNativeWebView) {
                try {
                    // å¤„ç†console.logçš„CSSæ ·å¼åŒ–å‚æ•°
                    const argsArray = Array.from(args);
                    let processedArgs = [];
                    
                    for (let i = 0; i < argsArray.length; i++) {
                        const arg = argsArray[i];
                        
                        // å¦‚æœæ˜¯å­—ç¬¦ä¸²ä¸”åŒ…å«%cï¼Œè¯´æ˜ä¸‹ä¸€ä¸ªå‚æ•°æ˜¯CSSæ ·å¼
                        if (typeof arg === 'string' && arg.includes('%c')) {
                            // ç§»é™¤%cæ ‡è®°ï¼Œä¿ç•™æ–‡æœ¬å†…å®¹
                            const cleanedArg = arg.replace(/%c/g, '');
                            processedArgs.push(cleanedArg);
                            
                            // è·³è¿‡ä¸‹ä¸€ä¸ªCSSæ ·å¼å‚æ•°
                            const nextArg = argsArray[i + 1];
                            if (typeof nextArg === 'string' && 
                                (nextArg.includes('color:') || nextArg.includes('font-'))) {
                                i++; // è·³è¿‡CSSæ ·å¼å‚æ•°
                            }
                        } else {
                            // æ™®é€šå‚æ•°ï¼Œç›´æ¥å¤„ç†
                            if (typeof arg === 'object' && arg !== null) {
                                try {
                                    processedArgs.push(JSON.stringify(arg));
                                } catch (e) {
                                    processedArgs.push(String(arg));
                                }
                            } else {
                                processedArgs.push(String(arg));
                            }
                        }
                    }
                    
                    const message = processedArgs.join(' ');
                    
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'webview_log',
                        level: level,
                        message: message,
                        timestamp: new Date().toISOString()
                    }));
                } catch (e) {
                    originalConsoleError('Failed to send log to native:', e);
                }
            }
            // ä¿æŒåŸæœ‰çš„consoleåŠŸèƒ½
            if (level === 'error') {
                originalConsoleError.apply(console, args);
            } else if (level === 'warn') {
                originalConsoleWarn.apply(console, args);
            } else if (level === 'info') {
                originalConsoleInfo.apply(console, args);
            } else {
                originalConsoleLog.apply(console, args);
            }
        }
        
        // é‡å†™consoleæ–¹æ³•ï¼Œæ”¯æŒå¤šå‚æ•°
        console.log = function() {
            sendLogToNative('info', arguments);
        };
        
        console.error = function() {
            sendLogToNative('error', arguments);
        };
        
        console.warn = function() {
            sendLogToNative('warn', arguments);
        };
        
        console.info = function() {
            sendLogToNative('info', arguments);
        };
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: Arial, sans-serif;
        }
        
        #container {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        

        
        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #333;
        }
        
        
        
        #status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1;
        }
        
        #audio-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1;
        }
        
        #error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 1001;
            display: none;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="loading">è¿æ¥ä¸­...</div>
        <div id="error-message"></div>

        <div id="remote-video"></div>
        
        <div id="status" style="display:'block'">æœªè¿æ¥</div>
        <div id="audio-status" style="display: 'block'">éŸ³é¢‘æœªå¯ç”¨</div>
        
        
    </div>

    <script>
        let rtc = {
            client: null,
            localVideoTrack: null,
            localAudioTrack: null,
        };
        
        // é»˜è®¤é…ç½®ï¼Œä¼šè¢« React Native ä¼ é€’çš„é…ç½®è¦†ç›–
        let options = {
            appId: "",
            channel: "",
            token: "",
            uid: null,
        };
        
        // é…ç½®æ˜¯å¦å·²æ¥æ”¶æ ‡å¿—
        let configReceived = false;
        
        // æ·»åŠ é…ç½®è°ƒè¯•æ—¥å¿—
        console.log('ğŸ¯ åˆå§‹åŒ– Agora é…ç½®ï¼ˆç­‰å¾… React Native ä¼ é€’ï¼‰:', options);
        
        let isVideoMuted = false;
        let isAudioMuted = false;
        let isTalking = false;
        let hasRemoteAudio = false;
        let connectionState = 'disconnected';
        
        // éŸ³é¢‘ç¼–ç é…ç½®é€‰é¡¹ - é’ˆå¯¹å¯¹è®²ä¼˜åŒ–
        const audioConfigs = {
            // è¯­éŸ³é€šè¯ä¼˜åŒ– (16kHz, Mono, ~32kbps) - é€‚åˆå¯¹è®²
            "speech_low_quality": {
                sampleRate: 16000,
                stereo: false,
                bitrate: 32
            },
            // æ ‡å‡†è¯­éŸ³ (32kHz, Mono, ~64kbps) 
            "speech_standard": {
                sampleRate: 32000,
                stereo: false,
                bitrate: 64
            }
        };
        
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateStatus(status) {
            // åªæœ‰è°ƒè¯•ç”¨æˆ·æ‰æ˜¾ç¤ºçŠ¶æ€
            // const isDebugUser = ${DebugTool.isDebugUsers()};
            // if (isDebugUser) {
            //     document.getElementById('status').textContent = status;
            // } else {
            //     document.getElementById('status').textContent = '';
            // }
            connectionState = status;
            
            // é€šçŸ¥ React Native
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'statusChanged',
                    status: status
                }));
            }
        }
        
        function updateAudioStatus(status) {
            // åªæœ‰è°ƒè¯•ç”¨æˆ·æ‰æ˜¾ç¤ºéŸ³é¢‘çŠ¶æ€
            // const isDebugUser = ${DebugTool.isDebugUsers()};
            // if (isDebugUser) {
            //     document.getElementById('audio-status').textContent = status;
            // } else {
            //     document.getElementById('audio-status').textContent = '';
            // }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // å¦‚æœæ˜¯æˆåŠŸæ¶ˆæ¯ï¼Œæ”¹å˜æ ·å¼
            if (message.includes('æˆåŠŸ')) {
                errorDiv.style.background = 'rgba(76, 175, 80, 0.8)';
            } else {
                errorDiv.style.background = 'rgba(255, 0, 0, 0.8)';
            }
            
            // é€šçŸ¥ React Native
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'error',
                    message: message
                }));
            }
        }
        
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // åˆå§‹åŒ– Agora å®¢æˆ·ç«¯
        async function initializeAgora() {
            console.log('ğŸ¯ å¼€å§‹åˆå§‹åŒ– Agora å®¢æˆ·ç«¯');
            try {
                // æ˜ç¡®è®¾ç½®ä¸ºä¸»æ’­è§’è‰²ï¼Œç¡®ä¿æœ‰å‘å¸ƒæƒé™
                rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
                console.log('ğŸ¯ Agora å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸï¼ˆä¸»æ’­æ¨¡å¼ï¼‰');
                
                // ç›‘å¬äº‹ä»¶
                rtc.client.on("user-published", handleUserPublished);
                rtc.client.on("user-unpublished", handleUserUnpublished);
                rtc.client.on("user-joined", handleUserJoined);
                rtc.client.on("user-left", handleUserLeft);
                rtc.client.on("connection-state-change", handleConnectionStateChange);
                console.log('ğŸ¯ Agora äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
                
                updateStatus('å·²åˆå§‹åŒ–');
                hideLoading();
                console.log('ğŸ¯ Agora åˆå§‹åŒ–å®Œæˆ');
                
                // é€šçŸ¥ React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'initialized'
                    }));
                    console.log('ğŸ¯ å·²é€šçŸ¥ React Native åˆå§‹åŒ–å®Œæˆ');
                } else {
                    console.error('ğŸ¯ window.ReactNativeWebView ä¸å­˜åœ¨');
                }
                
            } catch (error) {
                console.error('ğŸ¯ åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ›å»ºå¹¶å‘å¸ƒåˆå§‹è½¨é“ï¼ˆåŠ å…¥é¢‘é“åç«‹å³è°ƒç”¨ï¼‰
        async function createAndPublishInitialTracks() {
            try {
                console.log('ğŸ¯ å¼€å§‹åˆ›å»ºåˆå§‹è½¨é“...');
                const tracks = [];
                
                // åˆ›å»ºéŸ³é¢‘è½¨é“ï¼ˆé™éŸ³çŠ¶æ€ï¼‰
                const audioTrack = await createAudioTrack();
                if (audioTrack) {
                    // ç«‹å³é™éŸ³ï¼Œç”¨æˆ·ç‚¹å‡»å¯¹è®²æ—¶å†å–æ¶ˆé™éŸ³
                    await audioTrack.setMuted(true);
                    isAudioMuted = true;
                    tracks.push(audioTrack);
                    console.log('âœ… éŸ³é¢‘è½¨é“å·²åˆ›å»ºï¼ˆé™éŸ³çŠ¶æ€ï¼‰');
                }
                
                // ä¸åˆ›å»ºæœ¬åœ°è§†é¢‘è½¨é“ï¼Œåªä½¿ç”¨éŸ³é¢‘è½¨é“
                
                // å‘å¸ƒæ‰€æœ‰è½¨é“
                if (tracks.length > 0) {
                    await rtc.client.publish(tracks);
                    console.log(`âœ… å·²å‘å¸ƒ ${tracks.length} ä¸ªè½¨é“ï¼Œè·å¾—ä¸»æ’­æƒé™`);
                    
                    updateAudioStatus('è½¨é“å·²å‘å¸ƒï¼ˆéŸ³é¢‘é™éŸ³ï¼‰');
                    
                    // é€šçŸ¥ React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'tracksPublished',
                            audioTrack: !!audioTrack,
                        }));
                    }
                } else {
                    console.warn('âš ï¸ æ²¡æœ‰è½¨é“å¯å‘å¸ƒ');
                }
                
            } catch (error) {
                console.error('âŒ åˆ›å»ºåˆå§‹è½¨é“å¤±è´¥:', error);
                showError('åˆ›å»ºåª’ä½“è½¨é“å¤±è´¥: ' + error.message);
            }
        }
        
        // ç§»é™¤æœ¬åœ°è§†é¢‘è½¨é“åˆ›å»ºåŠŸèƒ½
        
        // åˆ›å»ºéŸ³é¢‘è½¨é“ï¼ˆå‚è€ƒ agora-test.html çš„æˆåŠŸåšæ³•ï¼‰
        async function createAudioTrack() {
            try {
                console.log('ğŸ¤ å¼€å§‹åˆ›å»ºéŸ³é¢‘è½¨é“...');
                
                // ä½¿ç”¨ä¸ agora-test.html å®Œå…¨ç›¸åŒçš„é…ç½®
                const config = audioConfigs["speech_low_quality"];
                
                // åˆ›å»º Agora éŸ³é¢‘è½¨é“
                rtc.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack({
                    encoderConfig: {
                        sampleRate: config.sampleRate,
                        stereo: config.stereo,
                        bitrate: config.bitrate
                    },
                    // å¯ç”¨éŸ³é¢‘å¤„ç†
                    AEC: true,  // å›å£°æ¶ˆé™¤
                    AGC: true,  // è‡ªåŠ¨å¢ç›Šæ§åˆ¶
                    ANS: true   // å™ªå£°æŠ‘åˆ¶
                });
                
                console.log('âœ… éŸ³é¢‘è½¨é“åˆ›å»ºæˆåŠŸ');
                console.log('ğŸ”§ éŸ³é¢‘é…ç½®:', {
                    sampleRate: config.sampleRate + 'Hz',
                    channels: config.stereo ? 'Stereo' : 'Mono',
                    bitrate: config.bitrate + 'kbps',
                    codec: 'Opus'
                });
                updateAudioStatus('éŸ³é¢‘è½¨é“å·²åˆ›å»º');
                
                // é€šçŸ¥ React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'audioTrackCreated'
                    }));
                }
                
                return rtc.localAudioTrack;
            } catch (error) {
                console.error('âŒ éŸ³é¢‘è½¨é“åˆ›å»ºå¤±è´¥:', error);
                
                let errorMsg = 'éŸ³é¢‘è½¨é“åˆ›å»ºå¤±è´¥';
                if (error.code === 'NOT_SUPPORTED') {
                    errorMsg = 'å½“å‰ç¯å¢ƒä¸æ”¯æŒéŸ³é¢‘åŠŸèƒ½';
                } else if (error.code === 'PERMISSION_DENIED' || error.message.includes('æƒé™')) {
                    errorMsg = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»';
                } else if (error.code === 'NOT_READABLE' || error.message.includes('NotReadableError')) {
                    errorMsg = 'æ— æ³•è®¿é—®éº¦å…‹é£è®¾å¤‡ï¼Œå¯èƒ½è¢«å…¶ä»–åº”ç”¨å ç”¨';
                } else {
                    errorMsg = `éŸ³é¢‘è½¨é“åˆ›å»ºå¤±è´¥: ${error.message}`;
                }
                
                showError(errorMsg);
                updateAudioStatus('éŸ³é¢‘è½¨é“åˆ›å»ºå¤±è´¥');
                return null;
            }
        }
        
        // åŠ å…¥é¢‘é“
        async function joinChannel() {
            try {
                hideError();

                // æ£€æŸ¥é…ç½®æ˜¯å¦å·²æ¥æ”¶
                if (!configReceived) {
                    console.log('ğŸ¯ é…ç½®å°šæœªæ¥æ”¶ï¼Œç­‰å¾…é…ç½®...');
                    showError('ç­‰å¾…é…ç½®ä¿¡æ¯...');
                    updateStatus('ç­‰å¾…é…ç½®');
                    
                    // è¯·æ±‚é…ç½®
                    sendMessageToReactNative({
                        type: 'requestConfig'
                    });
                    return;
                }

                // å…ˆå°è¯•è·å–ç”¨æˆ·åª’ä½“æƒé™ï¼ˆè¿™æ˜¯å…³é”®æ­¥éª¤ï¼‰
                try {
                    const testStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log('âœ… éŸ³é¢‘æƒé™è·å–æˆåŠŸ');
                    // ç«‹å³åœæ­¢æµ‹è¯•æµ
                    testStream.getTracks().forEach(track => track.stop());
                } catch (permError) {
                    console.error('âŒ éŸ³é¢‘æƒé™è·å–å¤±è´¥:', permError);
                    throw new Error('éº¦å…‹é£æƒé™è¢«æ‹’ç»æˆ–ä¸å¯ç”¨');
                }

                updateStatus('è¿æ¥ä¸­...');

                // æ£€æŸ¥é…ç½®æ˜¯å¦å®Œæ•´
                if (!options.appId || !options.channel || !options.token) {
                    showError('å£°ç½‘é…ç½®ä¸å®Œæ•´ï¼Œè¯·ç¨åé‡è¯•');
                    updateStatus('é…ç½®é”™è¯¯');
                    return;
                }

                
                // åŠ å…¥é¢‘é“
                options.uid = await rtc.client.join(
                    options.appId,
                    options.channel,
                    options.token,
                    options.uid
                );
                
                updateStatus('å·²è¿æ¥');
                console.log('âœ… æˆåŠŸåŠ å…¥é¢‘é“ï¼Œå¼€å§‹åˆ›å»ºå¹¶å‘å¸ƒè½¨é“...');
                
                // ç«‹å³åˆ›å»ºå¹¶å‘å¸ƒè½¨é“ï¼Œç¡®ä¿ä¸»æ’­æƒé™
                await createAndPublishInitialTracks();
                
                // é€šçŸ¥ React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'joinedChannel',
                        uid: options.uid,
                        channel: options.channel
                    }));
                }
                
            } catch (error) {
                console.error('åŠ å…¥é¢‘é“å¤±è´¥:', error);
                showError('åŠ å…¥é¢‘é“å¤±è´¥: ' + error.message);
                updateStatus('è¿æ¥å¤±è´¥');
            }
        }
        
        // ç¦»å¼€é¢‘é“
        async function leaveChannel() {
            try {
                // åœæ­¢å¯¹è®²
                if (isTalking) {
                    await stopTalk();
                }
                
                // æœ¬åœ°è§†é¢‘è½¨é“å·²ç§»é™¤
                
                if (rtc.localAudioTrack) {
                    rtc.localAudioTrack.stop();
                    rtc.localAudioTrack.close();
                    rtc.localAudioTrack = null;
                }
                
                // ç¦»å¼€é¢‘é“
                await rtc.client.leave();
                
                updateStatus('å·²æ–­å¼€');
                updateAudioStatus('éŸ³é¢‘æœªå¯ç”¨');
                
                
                // é‡ç½®çŠ¶æ€
                isTalking = false;
                hasRemoteAudio = false;
                isAudioMuted = false;
                isVideoMuted = false;
                
                
                // æ¸…ç©ºè§†é¢‘å®¹å™¨
                document.getElementById('remote-video').innerHTML = '';
                
                
                // é€šçŸ¥ React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'leftChannel'
                    }));
                }
                
            } catch (error) {
                console.error('ç¦»å¼€é¢‘é“å¤±è´¥:', error);
                showError('ç¦»å¼€é¢‘é“å¤±è´¥: ' + error.message);
            }
        }
        
        // å¼€å§‹å¯¹è®²
        async function startTalk() {
            try {
                console.log('ğŸ¤ å¼€å§‹å¯¹è®²...');
                
                // æ£€æŸ¥éŸ³é¢‘è½¨é“æ˜¯å¦å­˜åœ¨
                if (!rtc.localAudioTrack) {
                    console.log('ğŸ¤ éŸ³é¢‘è½¨é“ä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º...');
                    // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶å‘å¸ƒéŸ³é¢‘è½¨é“
                    const audioTrack = await createAudioTrack();
                    if (!audioTrack) {
                        showError('æ— æ³•åˆ›å»ºéŸ³é¢‘è½¨é“ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™');
                        return;
                    }
                    await rtc.client.publish([audioTrack]);
                }
                
                // å–æ¶ˆéŸ³é¢‘é™éŸ³
                if (rtc.localAudioTrack) {
                    await rtc.localAudioTrack.setMuted(false);
                    isAudioMuted = false;
                    isTalking = true;
                    updateAudioStatus('æ­£åœ¨å¯¹è®²...');
                    
                    console.log('âœ… å¯¹è®²å¼€å§‹æˆåŠŸï¼ˆå–æ¶ˆé™éŸ³ï¼‰');
                    
                    // é€šçŸ¥ React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'talkStarted'
                        }));
                    }
                } else {
                    showError('éŸ³é¢‘è½¨é“ä¸å¯ç”¨');
                }
                
            } catch (error) {
                console.error('âŒ å¼€å§‹å¯¹è®²å¤±è´¥:', error);
                showError('å¼€å§‹å¯¹è®²å¤±è´¥: ' + error.message);
                updateAudioStatus('å¯¹è®²å¯åŠ¨å¤±è´¥');
            }
        }
        
        // åœæ­¢å¯¹è®²
        async function stopTalk() {
            try {
                console.log('ğŸ”‡ åœæ­¢å¯¹è®²...');
                
                if (rtc.localAudioTrack) {
                    // è®¾ä¸ºé™éŸ³è€Œä¸æ˜¯å–æ¶ˆå‘å¸ƒï¼Œä¿æŒä¸»æ’­æƒé™
                    await rtc.localAudioTrack.setMuted(true);
                    isAudioMuted = true;
                    isTalking = false;
                    
                    updateAudioStatus(hasRemoteAudio ? 'æ¥æ”¶è¿œç«¯éŸ³é¢‘ï¼ˆæœ¬åœ°é™éŸ³ï¼‰' : 'éŸ³é¢‘è½¨é“å·²å‘å¸ƒï¼ˆé™éŸ³ï¼‰');
                    
                    console.log('âœ… å¯¹è®²åœæ­¢æˆåŠŸï¼ˆè®¾ä¸ºé™éŸ³ï¼‰');
                    
                    // é€šçŸ¥ React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'talkStopped'
                        }));
                    }
                } else {
                    console.log('âš ï¸ éŸ³é¢‘è½¨é“ä¸å­˜åœ¨ï¼Œæ— éœ€åœæ­¢å¯¹è®²');
                }
                
            } catch (error) {
                console.error('âŒ åœæ­¢å¯¹è®²å¤±è´¥:', error);
                showError('åœæ­¢å¯¹è®²å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ‡æ¢å¯¹è®²çŠ¶æ€
        async function toggleTalk() {
            if (isTalking) {
                await stopTalk();
            } else {
                await startTalk();
            }
        }
        
        // è§†é¢‘åŠŸèƒ½å·²ç§»é™¤
        
        // åˆ‡æ¢éŸ³é¢‘é™éŸ³
        async function toggleAudioMute() {
            try {
                if (!rtc.localAudioTrack) {
                    showError('è¯·å…ˆå¼€å§‹å¯¹è®²');
                    return;
                }
                
                isAudioMuted = !isAudioMuted;
                await rtc.localAudioTrack.setMuted(isAudioMuted);
                
                
                updateAudioStatus(isAudioMuted ? 'éŸ³é¢‘å·²é™éŸ³' : 'æ­£åœ¨å¯¹è®²...');
                
            } catch (error) {
                console.error('åˆ‡æ¢éŸ³é¢‘å¤±è´¥:', error);
                showError('åˆ‡æ¢éŸ³é¢‘å¤±è´¥: ' + error.message);
            }
        }
        
        // å¤„ç†è¿œç«¯ç”¨æˆ·å‘å¸ƒæµ
        async function handleUserPublished(user, mediaType) {
            try {
                console.log('ç”¨æˆ·å‘å¸ƒæµ:', user.uid, mediaType);
                await rtc.client.subscribe(user, mediaType);
                
                if (mediaType === 'video') {
                    console.log('å¼€å§‹æ’­æ”¾è¿œç«¯è§†é¢‘:', user.uid);
                    user.videoTrack.play('remote-video');
                    
                    // æ˜¾ç¤ºè¿œç«¯è§†é¢‘
                    document.getElementById('remote-video').style.display = 'block';
                    
                    // é€šçŸ¥ React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'remoteVideoStarted',
                            uid: user.uid
                        }));
                    }
                }
                
                if (mediaType === 'audio') {
                    console.log('å¼€å§‹æ’­æ”¾è¿œç«¯éŸ³é¢‘:', user.uid);
                    user.audioTrack.play();
                    user.audioTrack.setVolume(100);
                    
                    hasRemoteAudio = true;
                    updateAudioStatus('æ¥æ”¶è¿œç«¯éŸ³é¢‘');
                    
                    // é€šçŸ¥ React Native
                    if (window.ReactNativeWebView) {
                        window.ReactNativeWebView.postMessage(JSON.stringify({
                            type: 'remoteAudioStarted',
                            uid: user.uid
                        }));
                    }
                }
                
            } catch (error) {
                console.error('è®¢é˜…è¿œç«¯æµå¤±è´¥:', error);
                showError('è®¢é˜…è¿œç«¯æµå¤±è´¥: ' + error.message);
            }
        }
        
        // å¤„ç†è¿œç«¯ç”¨æˆ·å–æ¶ˆå‘å¸ƒæµ
        function handleUserUnpublished(user, mediaType) {
            console.log('handleUserUnpublished', user, mediaType);
            if (mediaType === 'video') {
                console.log('è¿œç«¯ç”¨æˆ·åœæ­¢å‘å¸ƒè§†é¢‘:', user.uid);
                document.getElementById('remote-video').innerHTML = '';
                
                // è¿œç«¯ç”¨æˆ·å–æ¶ˆå‘å¸ƒè§†é¢‘æµæ—¶ï¼Œè‡ªåŠ¨ç¦»å¼€é¢‘é“
                console.log('è¿œç«¯ç”¨æˆ·å–æ¶ˆå‘å¸ƒè§†é¢‘æµï¼Œå‡†å¤‡ç¦»å¼€é¢‘é“...');
                setTimeout(() => {
                    leaveChannel();
                }, 500); // å»¶è¿Ÿ500msç¦»å¼€ï¼Œç¡®ä¿çŠ¶æ€æ›´æ–°å®Œæˆ
                
                // é€šçŸ¥ React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'remoteVideoStopped',
                        uid: user.uid
                    }));
                }
            }
            
            if (mediaType === 'audio') {
                console.log('è¿œç«¯ç”¨æˆ·åœæ­¢å‘å¸ƒéŸ³é¢‘:', user.uid);
                hasRemoteAudio = false;
                updateAudioStatus(isTalking ? 'æ­£åœ¨å¯¹è®²...' : 'éŸ³é¢‘æœªå¯ç”¨');
                
                // é€šçŸ¥ React Native
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({
                        type: 'remoteAudioStopped',
                        uid: user.uid
                    }));
                }
            }
        }
        
        // å¤„ç†ç”¨æˆ·åŠ å…¥
        function handleUserJoined(user) {
            console.log('ç”¨æˆ·åŠ å…¥:', user.uid);
            
            // é€šçŸ¥ React Native
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'userJoined',
                    uid: user.uid
                }));
            }
        }
        
        // å¤„ç†ç”¨æˆ·ç¦»å¼€
        function handleUserLeft(user) {
            console.log('ç”¨æˆ·ç¦»å¼€:', user.uid);
            
            // é€šçŸ¥ React Native
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({
                    type: 'userLeft',
                    uid: user.uid
                }));
            }
        }
        
        // å¤„ç†è¿æ¥çŠ¶æ€å˜åŒ–
        function handleConnectionStateChange(curState, revState, reason) {
            console.log('è¿æ¥çŠ¶æ€å˜åŒ–:', curState, revState, reason);
            
            let statusText = 'æœªçŸ¥çŠ¶æ€';
            switch (curState) {
                case 'DISCONNECTED':
                    statusText = 'æœªè¿æ¥';
                    break;
                case 'CONNECTING':
                    statusText = 'è¿æ¥ä¸­...';
                    break;
                case 'CONNECTED':
                    statusText = 'å·²è¿æ¥';
                    break;
                case 'RECONNECTING':
                    statusText = 'é‡è¿ä¸­...';
                    break;
                case 'DISCONNECTING':
                    statusText = 'æ–­å¼€ä¸­...';
                    break;
            }
            
            updateStatus(statusText);
        }
        
        // å‘é€æ¶ˆæ¯åˆ° React Native
        function sendMessageToReactNative(message) {
            if (window.ReactNativeWebView) {
                try {
                    window.ReactNativeWebView.postMessage(JSON.stringify(message));
                    console.log('ğŸ¯ å·²å‘é€æ¶ˆæ¯åˆ° React Native:', message);
                } catch (error) {
                    console.error('ğŸ¯ å‘é€æ¶ˆæ¯åˆ° React Native å¤±è´¥:', error);
                }
            } else {
                console.warn('ğŸ¯ window.ReactNativeWebView ä¸å­˜åœ¨ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
            }
        }
        
        // å¤„ç†è®¾ç½®é…ç½®æ¶ˆæ¯
        function handleSetConfig(config) {
            try {
                console.log('ğŸ¯ æ¥æ”¶åˆ°é…ç½®:', config);
                
                // éªŒè¯é…ç½®å®Œæ•´æ€§
                if (!config || !config.appId || !config.token || !config.channelName) {
                    console.error('ğŸ¯ é…ç½®ä¸å®Œæ•´:', config);
                    sendMessageToReactNative({
                        type: 'configError',
                        message: 'é…ç½®ä¸å®Œæ•´'
                    });
                    return;
                }
                
                // æ›´æ–°é…ç½®
                options.appId = config.appId;
                options.channel = config.channelName;
                options.token = config.token;
                configReceived = true;
                
                console.log('ğŸ¯ é…ç½®å·²æ›´æ–°:', {
                    appId: options.appId ? options.appId.substring(0, 8) + '...' : 'ç©º',
                    channel: options.channel || 'ç©º',
                    token: options.token ? options.token.substring(0, 20) + '...' : 'ç©º'
                });
                
                // å‘é€é…ç½®æ¥æ”¶ç¡®è®¤
                sendMessageToReactNative({
                    type: 'configReceived',
                    config: {
                        appId: !!options.appId,
                        channel: !!options.channel,
                        token: !!options.token
                    }
                });
                
            } catch (error) {
                console.error('ğŸ¯ å¤„ç†é…ç½®å¤±è´¥:', error);
                sendMessageToReactNative({
                    type: 'configError',
                    message: 'å¤„ç†é…ç½®å¤±è´¥: ' + error.message
                });
            }
        }
        
        
        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸ¯ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            if (window.sendEarlyLog) {
                window.sendEarlyLog('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡åˆå§‹åŒ–Agora');
            }
            initializeAgora();
        });
        

        // å¤„ç†æ¥è‡ª React Native çš„æ¶ˆæ¯
        const handleMessage = function(event) {
            console.log('ğŸ¯ WebView received message: ' + event.data);
            
            try {
                const data = JSON.parse(event.data);
                console.log('ğŸ¯ Parsed message data: ' + JSON.stringify(data));
                console.log('ğŸ¯ Message type: ' + data.type);
                
                switch (data.type) {
                    case 'setConfig':
                        console.log('ğŸ¯ Processing setConfig message');
                        handleSetConfig(data.config);
                        break;
                    case 'joinChannel':
                        console.log('ğŸ¯ Processing joinChannel message');
                        joinChannel();
                        break;
                    case 'leaveChannel':
                        console.log('ğŸ¯ Processing leaveChannel message');
                        leaveChannel();
                        break;
                    // è§†é¢‘åŠŸèƒ½å·²ç§»é™¤
                    case 'toggleAudio':
                        console.log('ğŸ¯ Processing toggleAudio message');
                        toggleAudioMute();
                        break;
                    case 'startTalk':
                        console.log('ğŸ¯ Processing startTalk message');
                        startTalk();
                        break;
                    case 'stopTalk':
                        console.log('ğŸ¯ Processing stopTalk message');
                        stopTalk();
                        break;
                    case 'toggleTalk':
                        console.log('ğŸ¯ Processing toggleTalk message');
                        toggleTalk();
                        break;
                    default:
                        console.log('ğŸ¯ Unknown message type: ' + data.type);
                        break;
                }
            } catch (error) {
                console.log('ğŸ¯ Error parsing message: ' + error.message);
            }
        };

        // ç­‰å¾…DOMåŠ è½½å®Œæˆåè®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ DOM åŠ è½½å®Œæˆï¼Œå¹³å°:', window.ReactNativeOS);
            
            // æ ¹æ®å¹³å°é€‰æ‹©ä¸åŒçš„äº‹ä»¶ç›‘å¬å™¨
            if (window.ReactNativeOS === "android") {
                console.log('ğŸ¯ Androidå¹³å°: åœ¨documentä¸Šè®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨');
                document.addEventListener("message", handleMessage);
            } else {
                console.log('ğŸ¯ iOSå¹³å°: åœ¨windowä¸Šè®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨');
                window.addEventListener("message", handleMessage);
            }
            
            console.log('ğŸ¯ æ¶ˆæ¯ç›‘å¬å™¨è®¾ç½®æˆåŠŸ');
        });
        
        // å¦‚æœDOMå·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥è®¾ç½®ç›‘å¬å™¨
        if (document.readyState === 'loading') {
            console.log('ğŸ¯ æ–‡æ¡£æ­£åœ¨åŠ è½½ä¸­ï¼Œç­‰å¾…DOMContentLoadedäº‹ä»¶');
        } else {
            console.log('ğŸ¯ æ–‡æ¡£å·²åŠ è½½å®Œæˆï¼Œç›´æ¥è®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨');
            console.log('ğŸ¯ å½“å‰å¹³å°:', window.ReactNativeOS);
            
            if (window.ReactNativeOS === "android") {
                console.log('ğŸ¯ Androidå¹³å°: åœ¨documentä¸Šè®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨');
                document.addEventListener("message", handleMessage);
            } else {
                console.log('ğŸ¯ iOSå¹³å°: åœ¨windowä¸Šè®¾ç½®æ¶ˆæ¯ç›‘å¬å™¨');
                window.addEventListener("message", handleMessage);
            }
            
            console.log('ğŸ¯ æ¶ˆæ¯ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
        }
    </script>
</body>
</html>
